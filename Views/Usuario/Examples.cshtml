@{
    ViewData["Title"] = "SPC";
    ViewData["Description"] = "Categories";
}

@section CSS {
    <link rel="stylesheet" href="~/lib/jquery-ui-1.13.2.custom/jquery-ui.min.css" />
    <link rel="stylesheet" href="~/lib/jquery-ui-1.13.2.custom/jquery-ui.structure.min.css" />
    <link rel="stylesheet" href="~/lib/jquery-ui-1.13.2.custom/jquery-ui.theme.css" />
    <link rel="stylesheet" href="~/lib/paramquery-pro/pqgrid.min.css" />
    <link rel="stylesheet" href="~/lib/paramquery-pro/themes/steelblue/pqgrid.css" />
    <link rel="stylesheet" href="~/lib/paramquery-pro/pqgrid.ui.min.css" />
}

<section class="content-header">
    <h1>
        @ViewData["Title"]
        <small>@ViewData["Description"]</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">@ViewData["Title"]</a></li>
        <li class="active">@ViewData["Description"]</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <!-- Default box -->
            <div class="box box-primary">
                <div class="box-body">
                    @* <div class="row"> *@
                    @* <div class="col-md-3 col-lg-3"> *@
                    <button type="button" id="btnNew" class="btn btn-primary  btn-sm" style="width:70px" title="New category"><i class="fa fa-save" aria-hidden="true"></i> New</button>
                    @* </div> *@
                    @* </div> *@
                </div>
                <!-- /.box-body -->
                <div class="box-body" style="padding-bottom:15px">
                    <div id="grid_json"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- /.box -->
</section>

<div class="modal fade" id="ModalWindow"></div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/lib/paramquery-pro/jsZip-2.5.0/jszip.min.js"></script>
    <script src="~/lib/paramquery-pro/jszip-utils-0.0.2/jszip-utils.min.js"></script>
    <script src="~/lib/paramquery-pro/pqgrid.min.js"></script>
    <script src="~/lib/paramquery-pro/localize/pq-localize-en.js"></script>
    <script src="~/lib/FileSaver/dist/FileSaver.min.js"></script>

    <script>
        // Move dialog
        $("#ModalWindow").draggable({
            handle: ".modal-header"
        });

        //array of columns.
        var colModel = [
            {
                title: "Id",
                width: 150,
                dataType: "int",
                dataIndx: "id",
                //hidden: "true"
            },
            {
                title: "Name",
                width: 800,
                dataType: "string",
                dataIndx: "name",
                filter: { crules: [{ condition: 'contain' }], menuIcon: true }
            },
            {
                title: "", editable: false, minWidth: 30, sortable: false, align: "center", menuIcon: false, resizable: false,
                render: function (ui) {
                    return "<a href='#' title='Update category' onclick='updateCategory(" + ui.rowData.id + ")' ><i class='ui-icon ui-icon-pencil' aria-hidden='true'></i></a>";
                }
            },
            {
                title: "", editable: false, minWidth: 30, sortable: false, align: "center", menuIcon: false, resizable: false,
                render: function (ui) {
                    return "<a href='#' title='Delete category' onclick='deleteCategory(" + ui.rowData.id + ")' ><i class='ui-icon ui-icon-trash' aria-hidden='true'></i></a>";
                }
            },
            // {
            //     title: "", editable: false, minWidth: 30, sortable: false, align: "center", menuIcon: false, resizable: false,
            //     render: function (ui) {
            //         return "<a href='@(Url.Action("Parameters", "Category"))?categoryId=" + ui.rowData.id + "' title='Show subcategories'> <i class='ui-icon ui-icon-folder-open' aria-hidden='true'> </i></a>";
            //     }
            // }
        ];

        $(function () {
            // Data grid
            var dataModel = {
                location: "remote",
                dataType: "JSON",
                method: "GET",
                getUrl: function () {
                    return { url: '@Url.Action("CategoriesJson", "Category", new { Area = "SPC" })' };
                },
                getData: function (response) {
                    return { data: response };
                }
            };

            //main object to be passed to pqGrid constructor.
            var obj = {
                minWidth: 700,
                height: window.innerHeight - 280,
                colModel: colModel,
                scrollModel: { autoFit: true },
                //flex: { one: true },
                scrollModel: { lastColumn: null },
                dataModel: dataModel,
                editable: false,
                menuIcon: true,
                menuUI: {
                    tabs: ['hideCols']
                },
                filterModel: {
                    on: true,
                    mode: "AND",
                    header: true
                },
                numberCell: { resizable: true, title: "#" },
            };

            $("#grid_json").pqGrid(obj);
        });

        $('#ModalWindow').on('shown.bs.modal', function () {
            var form = $("#form1")
                .removeData("validator")
                .removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse("#form1");
        });

        // New Category
        $("#btnNew").click(() => showWindowPopUp("@Url.Action("NewCategoryPopUp", "Category")"));

        // modify category
        let updateCategory = (id) => showWindowPopUp("@Url.Action("UpdateCategoryPopUp", "Category")" + "?id=" + id);
        // delete category
        let deleteCategory = (id) => showWindowPopUp("@Url.Action("DeleteCategoryPopUp", "Category")" + "?id=" + id);

        // Signal R
        let connection = new signalR.HubConnectionBuilder().withUrl(systemHubUrl()).build();
        connection.start();
        //
        connection.on("RefreshSPCCategoryGrid", function () {
            //
            console.log("RefreshSPCCategoryGrid");
            waitTime(function () {
                $grid = $(".grid_json").pqGrid('refresh');
                $grid = $("#grid_json").pqGrid('refreshDataAndView');
            });
        });
    </script>
}






 <!-------------------------------------------------Example view popup-------------------------------->
        @model EngineeringWebApp.Models.SPCCategory
@{
    ViewData["Title"] = Model.Id == 0 ? $"New Category" : $"Update Category: {Model.Id} - {Model.Name}";
}

<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header import-popup-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">@ViewData["Title"]</h4>
        </div>

        <form id="form1" asp-controller="Category" asp-action="SaveCategory" role="form" method="post" class="form-horizontal">
            <input type="hidden" asp-for="Id" />
            <div class="modal-body">
                <div class="box-body" style="padding-bottom: 0px !important;">
                    <div class="form-group space">
                        <label asp-for="Name" class="col-sm-2" style="padding-top:5px;"></label>
                        <div class="col-sm-10">
                            <input asp-for="Name" class="form-control" />
                        </div>
                    </div>
                    <div asp-validation-summary="All" class="text-danger" style="font-weight:bold"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-sm pull-left" data-dismiss="modal" style="width:70px;"><i class="fa fa-close" aria-hidden="true"></i> Close</button>
                <button type="submit" id="submit" class="btn btn-primary btn-sm" style="width:70px;"><i class="fa fa-save" aria-hidden="true"></i>  Save</button>
            </div>
        </form>
    </div>
    <!-- /.modal-content -->
</div>

<script>
    $(function () {
        var formProvider = $('#form1');
        formProvider.submit(function (e) {
            console.log(e);
            e.preventDefault();
            formProvider.validate();
            console.log(formProvider.valid());
            if (formProvider.valid()) {
                var form = $(this);
                $.post(form.attr('action'), form.serialize(), function (res) {
                    if (res.status === 'success') {
                        // Show message
                        swal("SPC Category", res.message, "success");
                        //swal.success(res.message);
                        // Hide window
                        $('#ModalWindow').modal("hide");
                    } else if (res.status === 'error') {
                        swal("SPC Category", res.message, "error");
                    }
                });
            }
        });
    });
</script>
